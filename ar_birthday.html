<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>AR Birthday â€” Magic Card</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <!-- A-Frame + AR.js -->
  <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
  <script src="https://cdn.rawgit.com/jeromeetienne/AR.js/2.2.1/aframe/build/aframe-ar.min.js"></script>

  <style>
    body { margin: 0; font-family: sans-serif; background: #000; color: #fff; }
    #instructions {
      position: absolute; left: 10px; top: 10px; z-index: 10;
      background: rgba(0,0,0,0.5); padding: 8px 12px; border-radius: 8px;
    }
    #startBtn {
      display:inline-block; margin-top:6px; padding:8px 12px; background:#ff6b81; color:white; border-radius:6px;
    }
    #hint { font-size: 0.9em; opacity: 0.9; margin-top:6px; }
  </style>
</head>
<body>
  <div id="instructions">
    <div>ã‚«ãƒ¼ãƒ‰ã®ãƒãƒ¼ã‚«ãƒ¼ï¼ˆHiroãƒãƒ¼ã‚«ãƒ¼ï¼‰ã‚’ã‚«ãƒ¡ãƒ©ã§ã‹ã–ã—ã¦ãã ã•ã„ã€‚</div>
    <div id="hint">â€»Hiroãƒãƒ¼ã‚«ãƒ¼ã¯ãƒãƒƒãƒˆã§ã€Œhiro markerã€æ¤œç´¢ã§å°åˆ·ã§ãã¾ã™ã€‚ã‚«ãƒ¼ãƒ‰ã«è²¼ã‚‹ã‹ã€ãƒãƒ¼ã‚«ãƒ¼ã®ä¸Šã«å†™çœŸã‚’ç½®ã„ã¦ãã ã•ã„ã€‚</div>
    <div><button id="startBtn">æ¼”å‡ºã‚’é–‹å§‹ã™ã‚‹</button></div>
  </div>

  <!-- assets: ç½®ãæ›ãˆã¦ãã ã•ã„ -->
  <a-assets>
    <!-- å½¼å¥³ã¨ã®ãƒ„ãƒ¼ã‚·ãƒ§ãƒƒãƒˆç”»åƒã€‚ar_birthday.html ã¨åŒã˜ãƒ•ã‚©ãƒ«ãƒ€ã« couple.jpg ã‚’ç½®ãã‹ã€å…¬é–‹URLã«å¤‰ãˆã‚‹ -->
    <img id="photo" src="couple.jpg" crossorigin="anonymous" />
    <!-- ãƒãƒ¼ãƒˆç”»åƒï¼ˆç°¡æ˜“SVGãƒ‡ãƒ¼ã‚¿URLï¼‰ -->
    <img id="heart" src='data:image/svg+xml;utf8,\
      <svg xmlns="http://www.w3.org/2000/svg" width="128" height="128" viewBox="0 0 24 24">\
      <path fill="%23ff6b81" d="M12 21s-7.5-4.9-10-8.3C.4 9.8 3.1 6 6.2 6 8 6 9.4 7 10 8c.6-1 2-2 3.8-2 3.1 0 5.8 3.8 4.2 6.7C19.5 16.1 12 21 12 21z"/>\
      </svg>' crossorigin="anonymous" />
    <!-- é¢¨èˆ¹ï¼ˆä¸¸ï¼‰ -->
    <img id="balloon" src='data:image/svg+xml;utf8,\
      <svg xmlns="http://www.w3.org/2000/svg" width="96" height="128" viewBox="0 0 24 32">\
      <ellipse cx="12" cy="10" rx="8" ry="10" fill="%23ffd166"/><rect x="11" y="20" width="2" height="6" fill="%23ffd166"/>\
      </svg>' crossorigin="anonymous" />
  </a-assets>

  <!-- A-Frame ã‚·ãƒ¼ãƒ³ï¼ˆARãƒ¢ãƒ¼ãƒ‰ï¼‰ -->
  <a-scene embedded arjs='sourceType: webcam; debugUIEnabled: false;'>
    <!-- Hiro ãƒãƒ¼ã‚«ãƒ¼ã‚’ä½¿ã† -->
    <a-marker preset="hiro" id="marker">
      <!-- èƒŒæ™¯ã¨ãªã‚‹å†™çœŸãƒ—ãƒ¬ãƒ¼ãƒ³ï¼ˆå†™çœŸãŒæµ®ã‹ã¶ï¼‰-->
      <a-plane id="photoPlane" src="#photo" position="0 0 0" rotation="-90 0 0" width="1.2" height="0.8" material="shader: flat; opacity: 0.95"></a-plane>

      <!-- ä¸­å¤®ã®ãƒ†ã‚­ã‚¹ãƒˆï¼ˆãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³ï¼‰ -->
      <a-entity id="centerText" position="0 0.45 0" rotation="-90 0 0" visible="false">
        <a-text value="" align="center" color="#fff" width="1.4" baseline="center"></a-text>
      </a-entity>

      <!-- èŠ±ã³ã‚‰ã‚¨ãƒŸãƒƒã‚¿ã®è¦ª -->
      <a-entity id="petalEmitter" position="0 0.4 0" rotation="-90 0 0"></a-entity>

      <!-- ãƒãƒ¼ãƒˆã‚„é¢¨èˆ¹ã¯JSã§ã‚¹ãƒãƒ¼ãƒ³ -->
    </a-marker>

    <!-- ã‚«ãƒ¡ãƒ© -->
    <a-entity camera></a-entity>
  </a-scene>

  <!-- BGMï¼ˆå·®ã—æ›¿ãˆå¯èƒ½ï¼‰ -->
  <audio id="bgm" src="" preload="auto"></audio>

  <script>
  /****************************************************************
   * 2åˆ†ã‚¹ãƒˆãƒ¼ãƒªãƒ¼åˆ¶å¾¡ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
   * - ãƒãƒ¼ã‚«ãƒ¼èªè­˜ã§æ¼”å‡ºã‚’é–‹å§‹ï¼ˆã¾ãŸã¯ "é–‹å§‹" ãƒœã‚¿ãƒ³ï¼‰
   * - ãƒãƒ¼ãƒˆ/é¢¨èˆ¹/èŠ±ã³ã‚‰/ãƒ†ã‚­ã‚¹ãƒˆ/èŠ±ç«ï¼ˆã‚¿ãƒƒãƒ—ã§ï¼‰ã‚’é †ã«å‡ºã™
   ****************************************************************/
  (function(){
    const marker = document.querySelector('#marker');
    const centerTextEntity = document.querySelector('#centerText');
    const centerText = centerTextEntity.querySelector('a-text');
    const petalEmitter = document.querySelector('#petalEmitter');
    const startBtn = document.getElementById('startBtn');
    const bgm = document.getElementById('bgm');

    // ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºå¯èƒ½ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆæ—¥æœ¬èªã§ãƒ©ãƒ–ãƒ¬ã‚¿ãƒ¼èª¿ï¼‰
    const messages = [
      "ä»Šæ—¥ã¯ç‰¹åˆ¥ãªæ—¥ã ã‹ã‚‰ã€é­”æ³•ã‚’ã‹ã‘ã‚‹ã­ã€‚",
      "Happy 32nd Birthday ã€œâ—‹â—‹ã€œ",
      "ä»Šã¾ã§ä¸€ç·’ã«éã”ã—ãŸæ™‚é–“ãŒã€\nåƒ•ã®å®ç‰©ã§ã™ã€‚",
      "ã“ã‚Œã‹ã‚‰ã‚‚ç¬‘ã„åˆã£ã¦ã€æ”¯ãˆåˆã£ã¦ã€\nãšã£ã¨ä¸€ç·’ã«æ­©ã‚“ã§ã„ã“ã†ã€‚",
      "Next Step: Marriage ğŸ’\nã“ã‚Œã‹ã‚‰ã‚‚ã€ã‚ˆã‚ã—ãã­ã€‚"
    ];

    // æ¼”å‡ºã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ï¼ˆç§’ã€é–‹å§‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ï¼‰
    const timeline = [
      { t: 0.0, fn: startSparkles },
      { t: 0.2, fn: spawnHearts },      // 0:20
      { t: 0.6, fn: showMessage.bind(null, messages[0]) },
      { t: 1.2, fn: showMessage.bind(null, messages[1]) },
      { t: 2.0, fn: spawnBalloons },
      { t: 3.5, fn: showPetals },
      { t: 4.5, fn: showMessage.bind(null, messages[2]) },
      { t: 6.5, fn: showMessage.bind(null, messages[3]) },
      { t: 9.0, fn: showMessage.bind(null, messages[4]) },
      { t: 10.5, fn: finalFireworks }   // ã‚¯ãƒ©ã‚¤ãƒãƒƒã‚¯ã‚¹ï¼ˆæŠ¼ã—ã¦ã‚‚OKï¼‰
    ];

    // ç§’â†’ãƒŸãƒªç§’å¤‰æ›ï¼ˆã‚¿ã‚¤ãƒŸãƒ³ã‚°ã¯ãŠãŠã‚ˆãï¼‰
    const timelineMs = timeline.map(x => ({ t: Math.round(x.t * 1000), fn: x.fn }));

    let started = false;
    let timeouts = [];

    // ãƒãƒ¼ã‚«ãƒ¼ãŒè¦‹ãˆãŸã‚‰è‡ªå‹•ã§é–‹å§‹ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
    marker.addEventListener('markerFound', () => {
      // è‡ªå‹•ã§é–‹å§‹ã—ãŸã„å ´åˆã¯ã“ã“ã‚’æœ‰åŠ¹ã«ï¼ˆä»Šã¯ãƒœã‚¿ãƒ³ã§ã®é–‹å§‹æ¨å¥¨ï¼‰
      // if (!started) startShow();
    });

    startBtn.addEventListener('click', () => {
      if (!started) startShow();
    });

    function startShow(){
      started = true;
      startBtn.textContent = 'æ¼”å‡ºã‚’å†ç”Ÿä¸­â€¦';
      startBtn.disabled = true;

      // BGMãŒã‚ã‚Œã°å†ç”Ÿï¼ˆå·®ã—æ›¿ãˆã¦ä¸‹ã•ã„ï¼‰
      if (bgm.src) {
        try { bgm.currentTime = 0; bgm.play(); } catch(e){}
      }

      // ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚’å®Ÿè¡Œ
      timelineMs.forEach(item => {
        const id = setTimeout(item.fn, item.t);
        timeouts.push(id);
      });
    }

    // ã‚¯ãƒªã‚¢ï¼ˆå¿…è¦ãªã‚‰ï¼‰
    function clearShow(){
      timeouts.forEach(id => clearTimeout(id));
      timeouts = [];
      started = false;
      startBtn.textContent = 'æ¼”å‡ºã‚’é–‹å§‹ã™ã‚‹';
      startBtn.disabled = false;
    }

    /* ---------- æ¼”å‡ºãƒ‘ãƒ¼ãƒ„ ---------- */

    // 1) ã‚­ãƒ©ã‚­ãƒ©ï¼ˆç°¡æ˜“: small sprites ã‚’ã‚†ã‚‰ã‚†ã‚‰ï¼‰
    function startSparkles(){
      for(let i=0;i<20;i++){
        spawnSparkle( (Math.random()*0.8 - 0.4), (Math.random()*0.4 + 0.1), (Math.random()*0.8-0.4) );
      }
    }
    function spawnSparkle(x,y,z){
      const el = document.createElement('a-entity');
      el.setAttribute('geometry', { primitive: 'plane', width: 0.03, height: 0.03 });
      el.setAttribute('material', { color: '#fff', opacity: 0.9, shader:'flat' });
      el.setAttribute('position', `${x} ${y} ${z}`);
      el.setAttribute('rotation', '-90 0 0');
      el.setAttribute('animation', `property: position; to: ${x} ${y+0.12} ${z}; dur: 800; easing: easeOutQuad`);
      el.setAttribute('animation__fade', `property: material.opacity; to: 0; dur: 1200; delay: 400`);
      marker.appendChild(el);
      setTimeout(()=> el.remove(), 1400);
    }

    // 2) ãƒãƒ¼ãƒˆç¾¤
    function spawnHearts(){
      for(let i=0;i<12;i++){
        spawnHeart(Math.random()*0.7 - 0.35, Math.random()*0.15 + 0.25, Math.random()*0.6 - 0.3, 1200 + Math.random()*2000);
      }
    }
    function spawnHeart(x,y,z,dur){
      const el = document.createElement('a-image');
      el.setAttribute('src','#heart');
      el.setAttribute('width', 0.12);
      el.setAttribute('height', 0.12);
      el.setAttribute('position', `${x} ${y} ${z}`);
      el.setAttribute('rotation','-90 0 0');
      el.setAttribute('material', 'transparent: true; opacity:0');
      marker.appendChild(el);
      // fade in & float up
      el.setAttribute('animation__fadein', `property: material.opacity; to: 1; dur: 300; easing: easeInSine`);
      el.setAttribute('animation__float', `property: position; to:${x} ${y+0.5} ${z}; dur:${dur}; easing: easeOutQuad`);
      // fadeout after some time
      setTimeout(()=> {
        el.setAttribute('animation__fadeout', `property: material.opacity; to:0; dur:600`);
        setTimeout(()=> el.remove(), 800);
      }, dur - 300);
    }

    // 3) é¢¨èˆ¹ï¼ˆã‚†ã£ãã‚Šä¸Šæ˜‡ï¼‰
    function spawnBalloons(){
      for(let i=0;i<6;i++){
        spawnBalloon(Math.random()*0.6 - 0.3, 0.15 + Math.random()*0.05, Math.random()*0.6 - 0.3, 3500 + Math.random()*1500);
      }
    }
    function spawnBalloon(x,y,z,dur){
      const el = document.createElement('a-image');
      el.setAttribute('src','#balloon');
      el.setAttribute('width', 0.16);
      el.setAttribute('height', 0.2);
      el.setAttribute('position', `${x} ${y} ${z}`);
      el.setAttribute('rotation','-90 0 0');
      el.setAttribute('material', 'transparent: true; opacity:0');
      marker.appendChild(el);
      el.setAttribute('animation__appear', `property: material.opacity; to:1; dur:400`);
      el.setAttribute('animation__rise', `property: position; to:${x} ${y+0.9} ${z}; dur:${dur}; easing: easeOutSine`);
      setTimeout(()=> {
        el.setAttribute('animation__fade', `property: material.opacity; to:0; dur:800`);
        setTimeout(()=> el.remove(), 900);
      }, dur - 200);
    }

    // 4) èŠ±ã³ã‚‰ï¼ˆç´™å¹é›ªï¼‰
    function showPetals(){
      for(let i=0;i<30;i++){
        spawnPetal(Math.random()*1.0 - 0.5, 0.8 + Math.random()*0.2, Math.random()*1.0 - 0.5, 3000 + Math.random()*1500);
      }
    }
    function spawnPetal(x,y,z,dur){
      const el = document.createElement('a-entity');
      el.setAttribute('geometry', { primitive: 'plane', width: 0.04, height:0.04 });
      el.setAttribute('material', { color: '#ffd1dc', opacity: 1, shader:'flat' });
      el.setAttribute('position', `${x} ${y} ${z}`);
      el.setAttribute('rotation', '-90 0 0');
      marker.appendChild(el);
      // fall + rotate
      el.setAttribute('animation__fall', `property: position; to:${x+ (Math.random()-0.5)*0.4} ${y-0.9} ${z+ (Math.random()-0.5)*0.4}; dur:${dur}; easing: linear`);
      el.setAttribute('animation__rot', `property: rotation; to: ${-90} ${Math.random()*360} ${Math.random()*360}; dur:${dur}; easing: linear`);
      setTimeout(()=> {
        el.remove();
      }, dur+200);
    }

    // 5) ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºï¼ˆãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³ãƒ»è‡ªå‹•æ¶ˆå»ï¼‰
    function showMessage(text){
      centerTextEntity.setAttribute('visible', true);
      centerText.setAttribute('value', text);
      // opacityã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã™ã‚‹ãŸã‚ã«ä¸€æ—¦é€æ˜ã«ã—ã¦ã‹ã‚‰å‡ºã™
      centerText.setAttribute('opacity', 0);
      centerText.setAttribute('animation__fadein', 'property: opacity; to:1; dur:800');
      // è‡ªå‹•ã§æ¶ˆãˆã‚‹ï¼ˆæ¬¡ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã§ã‚‹ã¾ã§ï¼‰
      setTimeout(()=> {
        centerText.setAttribute('animation__fadeout', 'property: opacity; to:0; dur:600');
      }, 1500); // è¡¨ç¤ºæ™‚é–“ï¼ˆèª¿æ•´å¯ï¼‰
    }

    // 6) èŠ±ç«ï¼ˆã‚¯ãƒ©ã‚¤ãƒãƒƒã‚¯ã‚¹ã€‚ã‚¯ãƒªãƒƒã‚¯ã¾ãŸã¯è‡ªå‹•ï¼‰
    function finalFireworks(){
      // spawn multiple bursts
      for(let i=0;i<8;i++){
        setTimeout(()=> {
          spawnFirework((Math.random()*0.8-0.4), 0.6 + Math.random()*0.2, (Math.random()*0.8-0.4));
        }, i*120);
      }
    }
    function spawnFirework(cx, cy, cz){
      const particles = [];
      const count = 28;
      for(let i=0;i<count;i++){
        const angle = Math.random()*Math.PI*2;
        const speed = 0.5 + Math.random()*0.8;
        const el = document.createElement('a-sphere');
        el.setAttribute('radius', 0.015);
        el.setAttribute('material', `color: hsl(${Math.floor(Math.random()*360)},80%,60%); shader: flat;`);
        el.setAttribute('position', `${cx} ${cy} ${cz}`);
        marker.appendChild(el);
        particles.push({ el, angle, speed });
      }
      // animate particles by JS tick
      const start = performance.now();
      function tick(now){
        const dt = (now - start) / 600; // 0.. ~
        particles.forEach((p, idx) => {
          const dx = Math.cos(p.angle) * p.speed * dt;
          const dz = Math.sin(p.angle) * p.speed * dt;
          const dy = (p.speed * dt) - (0.5 * dt*dt); // gravity-ish
          p.el.setAttribute('position', `${cx + dx} ${cy + dy} ${cz + dz}`);
          // fade
          p.el.setAttribute('material', `opacity: ${Math.max(0, 1 - dt*1.2)}; color: ${p.el.getAttribute('material').color}`);
        });
        if (dt < 1.4) requestAnimationFrame(tick);
        else particles.forEach(p => p.el.remove());
      }
      requestAnimationFrame(tick);
    }

    // ã‚¯ãƒªãƒƒã‚¯ï¼ˆã‚¿ãƒƒãƒ—ï¼‰ã§èŠ±ç«ã‚’è¿½åŠ ã§ãã‚‹ã‚ˆã†ã«
    document.body.addEventListener('click', (ev) => {
      // ç”»é¢ã‚¿ãƒƒãƒ—ã§è¿½åŠ èŠ±ç«
      finalFireworks();
    });

    // --- END ---
  })();
  </script>
</body>
</html>